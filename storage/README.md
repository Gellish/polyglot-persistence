
# Storage Directory Specification

This directory contains runtime data generated by the application. All subdirectories are excluded from git except for the directory structure itself (via `.gitkeep` files).

## Structure

```
storage/
├── events/              # Event Store (Event Sourcing / CQRS)
│   ├── aggregates/      # Event streams organized by aggregate
│   │   ├── page-{uuid}/
│   │   │   └── event-{uuid}.json
│   │   └── user-{uuid}/
│   │       └── event-{uuid}.json
│   ├── projections/     # Read models (materialized views)
│   └── metadata/        # Event store metadata (sequence, checkpoints)
├── logs/                # Application logs
├── uploads/             # User-uploaded files
└── cache/               # Temporary cached data
```

## Event Store

The `events/` directory implements an **Event Sourcing / CQRS pattern** for offline-first functionality.

### Aggregates
- **Location**: `storage/events/aggregates/`
- **Purpose**: Append-only event log (source of truth)
- **Format**: `{aggregateType}-{aggregateId}/event-{eventId}.json`
- **Example**: `page-123e4567.../event-abc123...json`

### Event Structure
```json
{
  "eventId": "uuid",
  "aggregateId": "uuid",
  "aggregateType": "page|user",
  "eventType": "PAGE_UPDATED|USER_CREATED",
  "payload": { ... },
  "version": 1,
  "timestamp": "2026-02-01T..."
}
```

### Projections (Future)
- **Location**: `storage/events/projections/`
- **Purpose**: Optimized read models built from events
- **Format**: Materialized views for fast queries

### Metadata (Future)
- **Location**: `storage/events/metadata/`
- **Purpose**: Event store system state
- **Contents**: Global sequence numbers, projection checkpoints

## Usage

### Writing Events
```javascript
import { writeEvent } from '/app/Lib/cqrs/event-store.js';

await writeEvent({
  aggregateId: 'page-uuid',
  aggregateType: 'page',
  eventType: 'PAGE_UPDATED',
  payload: { title: 'New Title', content: '...' },
  version: 1
});
```

### Reading Events
```javascript
import { readEvents } from '/app/Lib/cqrs/event-store.js';

const events = await readEvents('page', 'page-uuid');
// Returns sorted array of events
```

## Git Ignore

All runtime data in `storage/` is excluded from git via `.gitignore`:
- ✅ Directory structure is tracked (via `.gitkeep`)
- ❌ Runtime data is excluded (events, logs, uploads, cache)

This ensures:
- Clean repository without runtime data
- Consistent directory structure across environments
- Each environment maintains its own data

## Benefits

✅ **Offline-First** - Events stored locally, can sync later
✅ **Audit Trail** - Complete history of all changes
✅ **Time Travel** - Rebuild state at any point in time
✅ **Event Sourcing** - Source of truth is the event log
✅ **CQRS** - Separate read/write models for performance
